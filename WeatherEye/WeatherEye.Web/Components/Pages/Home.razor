@page "/"
@using CAP.DTOs
@inject CAPApiClient CapApi

<PageTitle>Home</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-5">

    <MudText Typo="Typo.h3" Align="Align.Center" Color="Color.Primary" GutterBottom="true">
        🌦️ WeatherEye – systém výstrah
    </MudText>
    <MudText Typo="Typo.subtitle1" Align="Align.Center" Class="mb-4">
        Informační systém pro sledování nebezpečného počasí. Sledujte aktuální varování a nastavte si upozornění pro vámi vybraný region.
    </MudText>

    <Microsoft.AspNetCore.Components.Authorization.AuthorizeView>
        <NotAuthorized>
            <MudStack Row="true" Justify="Justify.Center" Class="mb-5">
                <MudButton Color="Color.Primary" Variant="Variant.Filled" Href="authentication/login">
                    Registrace
                </MudButton>
            </MudStack>
        </NotAuthorized>
    </Microsoft.AspNetCore.Components.Authorization.AuthorizeView>

    <MudStack Row="true" Spacing="3" Class="mb-5" Justify="Justify.Center">
        <MudCard Class="mx-2" Elevation="3">
            <MudCardHeader>
                <MudText Typo="Typo.h6">Notifikace (pouze po registraci)</MudText>
            </MudCardHeader>
            <MudCardContent>
                <MudText Typo="Typo.body2">
                    Upozornění je možné individuálně nastavit podle regionu, typu výstrahy a závažnosti.
                    Upozornění si můžete nechat zasílat emailem nebo si stáhnout naši mobilní aplikaci.
                </MudText>
            </MudCardContent>
        </MudCard>

        <MudCard Class="mx-2" Elevation="3">
            <MudCardHeader>
                <MudText Typo="Typo.h6">Přehled výstrah</MudText>
            </MudCardHeader>
            <MudCardContent>
                <MudText Typo="Typo.body2">
                    Aktuální i historické výstrahy podle typu nebezpečí, regionu, závažnosti a dalších parametrů.
                </MudText>
            </MudCardContent>
        </MudCard>
    </MudStack>

    <MudText Typo="Typo.h5" GutterBottom="true">Aktuální varování</MudText>

    <MudTable Items="Warnings" Dense="true" Hover="true" Striped="true" Bordered="true" Loading="@_loading">
        <HeaderContent>
            <MudTh>Datum</MudTh>
            <MudTh>Region</MudTh>
            <MudTh>Nebezpečí</MudTh>
            <MudTh>Závažnost</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd>@context.Onset.ToString("dd.MM.yyyy HH:mm")</MudTd>

            <MudTd>@context.AreaDesc</MudTd>
            <MudTd>@context.Event</MudTd>

            <MudTd>
                <MudChip T="string"
                         Color="@GetSeverityColor(context.Severity)"
                         Size="Size.Small"
                         Variant="Variant.Filled">
                    @context.Severity
                </MudChip>
            </MudTd>
        </RowTemplate>
        <NoRecordsContent>
            <MudText>Nenalezena žádná aktuální varování.</MudText>
        </NoRecordsContent>
        <LoadingContent>
            <MudText>Načítám data...</MudText>
        </LoadingContent>
    </MudTable>

</MudContainer>

@code {
    private IEnumerable<AlertInfoDTO>? Warnings;
    private bool _loading = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _loading = true;
            var alerts = await CapApi.GetAlertsAsync();

            if (alerts != null)
            {
                // Definujeme seznam závažností, které chceme na úvodní stránce
                var importantSeverities = new[] { "Extreme", "Severe", "Moderate" };
                // Pokud bys chtěl i střední, připiš do závorky: , "Moderate"

                Warnings = alerts
                    // 1. KROK: Vyfiltrujeme jen ty, co jsou v našem seznamu "důležitých"
                    .Where(x => importantSeverities.Contains(x.Severity, StringComparer.OrdinalIgnoreCase))
                    // 2. KROK: Seřadíme podle data začátku (nejnovější nahoře)
                    .OrderByDescending(x => x.Onset)
                    // 3. KROK: Vezmeme jen 5 nejnovějších
                    .Take(5);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Chyba při načítání dat: {ex.Message}");
        }
        finally
        {
            _loading = false;
        }
    }

    // NOVÁ METODA: Řeší logiku barev mimo HTML
    private Color GetSeverityColor(string? severity)
    {
        if (string.IsNullOrEmpty(severity))
            return Color.Default;

        // Porovnání bez ohledu na velká/malá písmena
        if (string.Equals(severity, "Extreme", StringComparison.OrdinalIgnoreCase) ||
            string.Equals(severity, "Severe", StringComparison.OrdinalIgnoreCase) ||
            string.Equals(severity, "High", StringComparison.OrdinalIgnoreCase))
        {
            return Color.Error;
        }

        if (string.Equals(severity, "Moderate", StringComparison.OrdinalIgnoreCase))
        {
            return Color.Warning;
        }

        // Pro Minor, Unknown atd.
        return Color.Info;
    }
}