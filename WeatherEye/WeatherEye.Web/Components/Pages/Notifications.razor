@page "/notifications"
@inject CAPApiClient CapApi
@inject UserApiClient UserApi

<MudText Typo="Typo.h4" GutterBottom="true">
    🔔 Nastavení Notifikací
</MudText>

<MudText Typo="Typo.subtitle1" Class="mb-4">
    Zde si můžete nastavit, jaké výstrahy a jakým způsobem chcete dostávat.
</MudText>
@if (AvailableRegions == null)
{
    <MudProgressCircular Color="Color.Default" Indeterminate="true" />
}
else
{
    @foreach (var block in filterBlocks)
    {
        <MudPaper Class="pa-16 ma-2" Elevation="3">
            <MudGrid>
                <MudItem xs="12" sm="6">
                    <MudSelect T="string" Label="Oblast" @bind-Value="block.SelectedRegion" Clearable="true">
                        @foreach (var a in AvailableRegions)
                        {
                            <MudSelectItem Value="@a">@a</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudSelect T="string" Label="Typ události" @bind-Value="block.SelectedEvent">
                        <MudSelectItem Value="@("Vsechny")">Všechny</MudSelectItem>
                        <MudSelectItem Value="@("Silny_vitr")">Silný vítr</MudSelectItem>
                        <MudSelectItem Value="@("Snezeni")">Sněžení/Ledovka</MudSelectItem>
                    </MudSelect>
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudSelect T="string" Label="Síla hrozby (Severity)" @bind-Value="block.SelectedSeverity">
                        <MudSelectItem Value="@("Vsechny")">Všechny</MudSelectItem>
                        <MudSelectItem Value="@("Minor")">Minor (Mírná)</MudSelectItem>
                        <MudSelectItem Value="@("Moderate")">Moderate (Střední)</MudSelectItem>
                        <MudSelectItem Value="@("Severe")">Severe (Velká)</MudSelectItem>
                    </MudSelect>
                </MudItem>

            </MudGrid>

            <MudDivider Class="my-6" />

            <MudText Typo="Typo.h6" Class="mb-4">
                Způsob upozornění
            </MudText>

            <MudGrid>
                <MudItem xs="12" sm="6">
                    <MudCheckBox T="bool" Checked="true" Color="Color.Primary" Label="Upozornění do aplikace (Bell icon)" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudCheckBox T="bool" Checked="false" Color="Color.Secondary" Label="Upozornění emailem" />
                </MudItem>
            </MudGrid>

            <MudDivider Class="my-6" />

            <MudItem xs="12">
                <MudButton Color="Color.Error" Variant="Variant.Filled" OnClick="() => RemoveBlock(block)">Odstranit notifikaci</MudButton>
            </MudItem>

        </MudPaper>
    }
}
<MudGrid>
    <MudItem xs="12">
        <MudButton Color="Color.Primary" Variant="Variant.Filled" Class="mt-6" OnClick="AddNewBlock">
            Přidat notifikaci
        </MudButton>
    </MudItem>

    <MudItem xs="12">
        <MudButton Color="Color.Success" Variant="Variant.Filled" Class="mt-6" OnClick="SavePreferences">
            💾 Uložit Notifikace
        </MudButton>
    </MudItem>
</MudGrid>

@code {
    private string[] AvailableRegions;
    private Preferences.DTO.AlertPreferenceDTO[] AlertPreferences;

    protected override async Task OnInitializedAsync()
    {
        AvailableRegions = await CapApi.GetAvailableRegionsAsync();
        AlertPreferences = await UserApi.GetAlertPreferenceAsync();
        foreach (var item in AlertPreferences)
        {
            AddNewBlock(item.AreaDesc);
        }
    }
    // Seznam bloků, kde každý blok obsahuje výběr hodnot
    private List<FilterBlock> filterBlocks = new List<FilterBlock>();

    // Třída, která drží vybrané hodnoty pro každý blok
    public class FilterBlock
    {
        public string SelectedRegion { get; set; }
        public string SelectedEvent { get; set; }
        public string SelectedSeverity { get; set; }
    }

    // Funkce pro přidání nového bloku
    private void AddNewBlock()
    {
        filterBlocks.Add(new FilterBlock
        {
            SelectedRegion = "", // default value
            SelectedEvent = "",          // default value
            SelectedSeverity = ""        // default value
        });
    }

    private void AddNewBlock(string SelectedRegion = "", string SelectedEvent = "", string SelectedSeverity = "")
    {
        filterBlocks.Add(new FilterBlock
        {
            SelectedRegion = SelectedRegion, // default value
            SelectedEvent = SelectedEvent,          // default value
            SelectedSeverity = SelectedSeverity        // default value
        });
    }

    private async void SavePreferences()
    {
        foreach (var item in filterBlocks)
        {
            try
            {
                await UserApi.SaveAlertPreference(item.SelectedRegion);

            }
            catch (Exception e)
            {

            }
        }
    }


    // Funkce pro odstranění bloku
    private void RemoveBlock(FilterBlock block)
    {
        filterBlocks.Remove(block);

        var pref = AlertPreferences.Where(x => x.AreaDesc == block.SelectedRegion).FirstOrDefault();
        if (pref is null) return;

        UserApi.DeleteAlertPreferenceAsync(pref.PreferenceOid);
    }
}
